"""Offline threat feed caches for CISA KEV and EPSS data.

Provides built-in snapshots of commonly exploited CVEs relevant to home
networks, routers, IoT devices, and common services.  All data is static
and works fully offline -- no external API calls are ever made.
"""

from __future__ import annotations

from typing import Any

import structlog

logger = structlog.get_logger()

# ---------------------------------------------------------------------------
# CISA Known Exploited Vulnerabilities (KEV) -- built-in snapshot
# Focused on CVEs relevant to home networks, routers, IoT, and common
# services (OpenSSH, Apache, nginx, DNS, NTP, etc.)
# ---------------------------------------------------------------------------
_KEV_CATALOG: list[dict[str, str]] = [
    # -- Router / Firewall --
    {
        "cve_id": "CVE-2018-13379",
        "vendor": "Fortinet",
        "product": "FortiOS",
        "description": "FortiOS SSL VPN path traversal allows unauthenticated file read (credentials).",
        "date_added": "2021-11-03",
        "required_action": "Upgrade FortiOS to a patched version; reset all VPN credentials.",
    },
    {
        "cve_id": "CVE-2019-1653",
        "vendor": "Cisco",
        "product": "RV320/RV325 Routers",
        "description": "Information disclosure via unauthenticated access to configuration.",
        "date_added": "2021-11-03",
        "required_action": "Apply firmware update from Cisco.",
    },
    {
        "cve_id": "CVE-2019-19781",
        "vendor": "Citrix",
        "product": "ADC / Gateway",
        "description": "Directory traversal leading to remote code execution.",
        "date_added": "2021-11-03",
        "required_action": "Apply Citrix-provided patches immediately.",
    },
    {
        "cve_id": "CVE-2020-5902",
        "vendor": "F5",
        "product": "BIG-IP",
        "description": "TMUI remote code execution vulnerability.",
        "date_added": "2021-11-03",
        "required_action": "Apply F5 hotfix or upgrade BIG-IP.",
    },
    {
        "cve_id": "CVE-2021-20090",
        "vendor": "Buffalo / Arcadyan",
        "product": "Various home routers",
        "description": "Authentication bypass in Arcadyan-based router firmware.",
        "date_added": "2021-11-03",
        "required_action": "Update router firmware to latest version.",
    },
    {
        "cve_id": "CVE-2017-17215",
        "vendor": "Huawei",
        "product": "HG532 Router",
        "description": "Remote code execution via crafted packets to UPnP service.",
        "date_added": "2021-11-03",
        "required_action": "Disable UPnP and update firmware.",
    },
    {
        "cve_id": "CVE-2023-20198",
        "vendor": "Cisco",
        "product": "IOS XE",
        "description": "Privilege escalation via web UI allows creation of admin account.",
        "date_added": "2023-10-16",
        "required_action": "Disable HTTP/HTTPS Server feature; apply Cisco patches.",
    },
    {
        "cve_id": "CVE-2024-3400",
        "vendor": "Palo Alto Networks",
        "product": "PAN-OS GlobalProtect",
        "description": "Command injection in GlobalProtect gateway allows unauthenticated RCE.",
        "date_added": "2024-04-12",
        "required_action": "Apply PAN-OS hotfix; enable Threat Prevention signatures.",
    },
    # -- IoT / Smart Home --
    {
        "cve_id": "CVE-2021-35394",
        "vendor": "Realtek",
        "product": "Realtek Jungle SDK",
        "description": "Multiple buffer overflows in UDPServer; used by many IoT devices.",
        "date_added": "2023-09-18",
        "required_action": "Contact device vendor for firmware update.",
    },
    {
        "cve_id": "CVE-2022-27255",
        "vendor": "Realtek",
        "product": "eCos RSDK",
        "description": "Remote buffer overflow in SIP ALG module affecting many routers.",
        "date_added": "2023-09-18",
        "required_action": "Update device firmware; disable SIP ALG if possible.",
    },
    {
        "cve_id": "CVE-2021-36260",
        "vendor": "Hikvision",
        "product": "IP Cameras",
        "description": "Command injection via crafted HTTP requests to IP cameras.",
        "date_added": "2022-01-10",
        "required_action": "Update camera firmware; restrict network access.",
    },
    {
        "cve_id": "CVE-2018-10561",
        "vendor": "Dasan / GPON",
        "product": "GPON Home Routers",
        "description": "Authentication bypass on GPON home routers.",
        "date_added": "2021-11-03",
        "required_action": "Replace or update affected GPON equipment.",
    },
    # -- OpenSSH --
    {
        "cve_id": "CVE-2023-38408",
        "vendor": "OpenBSD",
        "product": "OpenSSH",
        "description": "Remote code execution via ssh-agent forwarding with PKCS#11 providers.",
        "date_added": "2023-07-20",
        "required_action": "Upgrade to OpenSSH 9.3p2 or later.",
    },
    {
        "cve_id": "CVE-2024-6387",
        "vendor": "OpenBSD",
        "product": "OpenSSH",
        "description": "RegreSSHion: signal handler race condition allows unauthenticated RCE on glibc-based systems.",
        "date_added": "2024-07-01",
        "required_action": "Upgrade to OpenSSH 9.8p1 or later.",
    },
    {
        "cve_id": "CVE-2016-20012",
        "vendor": "OpenBSD",
        "product": "OpenSSH",
        "description": "User enumeration via timing side channel.",
        "date_added": "2021-11-03",
        "required_action": "Upgrade OpenSSH; implement fail2ban or rate limiting.",
    },
    # -- Apache HTTP Server --
    {
        "cve_id": "CVE-2021-41773",
        "vendor": "Apache",
        "product": "HTTP Server",
        "description": "Path traversal and remote code execution in Apache 2.4.49.",
        "date_added": "2021-11-03",
        "required_action": "Upgrade to Apache HTTP Server 2.4.51 or later.",
    },
    {
        "cve_id": "CVE-2021-42013",
        "vendor": "Apache",
        "product": "HTTP Server",
        "description": "Path traversal fix bypass in Apache 2.4.50.",
        "date_added": "2021-11-03",
        "required_action": "Upgrade to Apache HTTP Server 2.4.51 or later.",
    },
    {
        "cve_id": "CVE-2023-25690",
        "vendor": "Apache",
        "product": "HTTP Server",
        "description": "HTTP request smuggling via mod_proxy when RewriteRule and ProxyPassMatch are used.",
        "date_added": "2023-03-14",
        "required_action": "Upgrade to Apache HTTP Server 2.4.56 or later.",
    },
    # -- nginx --
    {
        "cve_id": "CVE-2021-23017",
        "vendor": "F5 / nginx",
        "product": "nginx",
        "description": "DNS resolver off-by-one heap write allows RCE.",
        "date_added": "2021-11-03",
        "required_action": "Upgrade nginx to 1.20.1 / 1.21.0 or later.",
    },
    {
        "cve_id": "CVE-2022-41741",
        "vendor": "F5 / nginx",
        "product": "nginx",
        "description": "Memory corruption in mp4 module allows local code execution.",
        "date_added": "2022-10-19",
        "required_action": "Upgrade to nginx 1.23.2 / 1.22.1 or later.",
    },
    # -- DNS / NTP / Network Services --
    {
        "cve_id": "CVE-2020-1350",
        "vendor": "Microsoft",
        "product": "Windows DNS Server",
        "description": "SIGRed: wormable RCE in Windows DNS Server via crafted DNS response.",
        "date_added": "2021-11-03",
        "required_action": "Apply Microsoft security update.",
    },
    {
        "cve_id": "CVE-2023-44487",
        "vendor": "Multiple",
        "product": "HTTP/2 implementations",
        "description": "HTTP/2 Rapid Reset DDoS attack vector.",
        "date_added": "2023-10-10",
        "required_action": "Apply vendor patches; configure rate limiting.",
    },
    # -- Common services / Libraries --
    {
        "cve_id": "CVE-2021-44228",
        "vendor": "Apache",
        "product": "Log4j",
        "description": "Log4Shell: RCE via JNDI lookup in log messages.",
        "date_added": "2021-12-10",
        "required_action": "Upgrade to Log4j 2.17.1+; set LOG4J_FORMAT_MSG_NO_LOOKUPS=true.",
    },
    {
        "cve_id": "CVE-2022-22965",
        "vendor": "VMware / Spring",
        "product": "Spring Framework",
        "description": "Spring4Shell: RCE via data binding on JDK 9+.",
        "date_added": "2022-04-04",
        "required_action": "Upgrade to Spring Framework 5.3.18+ or 5.2.20+.",
    },
    {
        "cve_id": "CVE-2014-0160",
        "vendor": "OpenSSL",
        "product": "OpenSSL",
        "description": "Heartbleed: TLS heartbeat extension memory disclosure.",
        "date_added": "2021-11-03",
        "required_action": "Upgrade to OpenSSL 1.0.1g or later; revoke and reissue certificates.",
    },
    {
        "cve_id": "CVE-2014-6271",
        "vendor": "GNU",
        "product": "Bash",
        "description": "Shellshock: arbitrary code execution via crafted environment variables.",
        "date_added": "2021-11-03",
        "required_action": "Update Bash to a patched version.",
    },
    {
        "cve_id": "CVE-2017-5638",
        "vendor": "Apache",
        "product": "Struts 2",
        "description": "RCE via Content-Type header in multipart parser.",
        "date_added": "2021-11-03",
        "required_action": "Upgrade Apache Struts to 2.3.32 / 2.5.10.1+.",
    },
    {
        "cve_id": "CVE-2019-0708",
        "vendor": "Microsoft",
        "product": "Remote Desktop Services",
        "description": "BlueKeep: pre-auth RCE in RDP on older Windows versions.",
        "date_added": "2021-11-03",
        "required_action": "Apply Microsoft security update; disable RDP if not needed.",
    },
    {
        "cve_id": "CVE-2020-0601",
        "vendor": "Microsoft",
        "product": "Windows CryptoAPI",
        "description": "CurveBall: spoofing vulnerability in certificate validation.",
        "date_added": "2021-11-03",
        "required_action": "Apply Microsoft security update.",
    },
    {
        "cve_id": "CVE-2021-26855",
        "vendor": "Microsoft",
        "product": "Exchange Server",
        "description": "ProxyLogon: SSRF leading to RCE in Exchange Server.",
        "date_added": "2021-11-03",
        "required_action": "Apply Microsoft emergency patch for Exchange.",
    },
    {
        "cve_id": "CVE-2023-27997",
        "vendor": "Fortinet",
        "product": "FortiOS / FortiProxy",
        "description": "Heap-based buffer overflow in SSL-VPN pre-authentication.",
        "date_added": "2023-06-13",
        "required_action": "Upgrade to patched FortiOS version.",
    },
    {
        "cve_id": "CVE-2022-42475",
        "vendor": "Fortinet",
        "product": "FortiOS",
        "description": "Heap-based buffer overflow in sslvpnd allows unauthenticated RCE.",
        "date_added": "2022-12-13",
        "required_action": "Upgrade FortiOS immediately.",
    },
]

# Build a lookup dict keyed by CVE ID for O(1) access
_KEV_INDEX: dict[str, dict[str, str]] = {entry["cve_id"]: entry for entry in _KEV_CATALOG}

# ---------------------------------------------------------------------------
# EPSS-style scores -- synthetic offline snapshot
# Scores are modeled after real EPSS percentile data for the same CVEs.
# Each entry contains: cve_id, epss_score (probability 0-1), percentile (0-100).
# ---------------------------------------------------------------------------
_EPSS_DATA: dict[str, dict[str, Any]] = {
    "CVE-2018-13379": {"epss_score": 0.974, "percentile": 99.8},
    "CVE-2019-1653":  {"epss_score": 0.968, "percentile": 99.6},
    "CVE-2019-19781": {"epss_score": 0.975, "percentile": 99.9},
    "CVE-2020-5902":  {"epss_score": 0.974, "percentile": 99.8},
    "CVE-2021-20090": {"epss_score": 0.957, "percentile": 99.2},
    "CVE-2017-17215": {"epss_score": 0.962, "percentile": 99.3},
    "CVE-2023-20198": {"epss_score": 0.961, "percentile": 99.3},
    "CVE-2024-3400":  {"epss_score": 0.955, "percentile": 99.1},
    "CVE-2021-35394": {"epss_score": 0.967, "percentile": 99.5},
    "CVE-2022-27255": {"epss_score": 0.200, "percentile": 80.0},
    "CVE-2021-36260": {"epss_score": 0.971, "percentile": 99.7},
    "CVE-2018-10561": {"epss_score": 0.973, "percentile": 99.8},
    "CVE-2023-38408": {"epss_score": 0.150, "percentile": 73.0},
    "CVE-2024-6387":  {"epss_score": 0.350, "percentile": 88.0},
    "CVE-2016-20012": {"epss_score": 0.050, "percentile": 45.0},
    "CVE-2021-41773": {"epss_score": 0.975, "percentile": 99.9},
    "CVE-2021-42013": {"epss_score": 0.975, "percentile": 99.9},
    "CVE-2023-25690": {"epss_score": 0.420, "percentile": 90.0},
    "CVE-2021-23017": {"epss_score": 0.500, "percentile": 92.0},
    "CVE-2022-41741": {"epss_score": 0.120, "percentile": 68.0},
    "CVE-2020-1350":  {"epss_score": 0.850, "percentile": 98.0},
    "CVE-2023-44487": {"epss_score": 0.600, "percentile": 94.0},
    "CVE-2021-44228": {"epss_score": 0.976, "percentile": 99.9},
    "CVE-2022-22965": {"epss_score": 0.974, "percentile": 99.8},
    "CVE-2014-0160":  {"epss_score": 0.975, "percentile": 99.9},
    "CVE-2014-6271":  {"epss_score": 0.976, "percentile": 99.9},
    "CVE-2017-5638":  {"epss_score": 0.975, "percentile": 99.9},
    "CVE-2019-0708":  {"epss_score": 0.974, "percentile": 99.8},
    "CVE-2020-0601":  {"epss_score": 0.350, "percentile": 88.0},
    "CVE-2021-26855": {"epss_score": 0.975, "percentile": 99.9},
    "CVE-2023-27997": {"epss_score": 0.800, "percentile": 97.0},
    "CVE-2022-42475": {"epss_score": 0.900, "percentile": 98.5},
}


class ThreatFeedCache:
    """Offline-capable cache for CISA KEV and EPSS threat-intelligence feeds.

    All lookups use the built-in static snapshots so the system never
    requires network access.
    """

    def __init__(self) -> None:
        self._kev_index: dict[str, dict[str, str]] = dict(_KEV_INDEX)
        self._epss_data: dict[str, dict[str, Any]] = dict(_EPSS_DATA)
        logger.info(
            "ThreatFeedCache initialised",
            kev_entries=len(self._kev_index),
            epss_entries=len(self._epss_data),
        )

    # -- public API ---------------------------------------------------------

    def get_kev_status(self, cve_id: str) -> dict | None:
        """Return KEV entry for *cve_id*, or ``None`` if not present."""
        cve_id = cve_id.strip().upper()
        entry = self._kev_index.get(cve_id)
        if entry is None:
            logger.debug("CVE not found in KEV", cve_id=cve_id)
            return None
        logger.debug("CVE found in KEV", cve_id=cve_id)
        return {
            "cve_id": entry["cve_id"],
            "vendor": entry["vendor"],
            "product": entry["product"],
            "description": entry["description"],
            "date_added": entry["date_added"],
            "required_action": entry["required_action"],
            "in_kev": True,
        }

    def get_epss_score(self, cve_id: str) -> dict | None:
        """Return EPSS data for *cve_id*, or ``None`` if not present."""
        cve_id = cve_id.strip().upper()
        entry = self._epss_data.get(cve_id)
        if entry is None:
            logger.debug("CVE not found in EPSS cache", cve_id=cve_id)
            return None
        logger.debug("CVE found in EPSS cache", cve_id=cve_id, score=entry["epss_score"])
        return {
            "cve_id": cve_id,
            "epss_score": entry["epss_score"],
            "percentile": entry["percentile"],
        }

    # -- bulk helpers -------------------------------------------------------

    def bulk_kev_check(self, cve_ids: list[str]) -> dict[str, dict | None]:
        """Check multiple CVEs against KEV in one call."""
        return {cve_id: self.get_kev_status(cve_id) for cve_id in cve_ids}

    def bulk_epss_check(self, cve_ids: list[str]) -> dict[str, dict | None]:
        """Retrieve EPSS data for multiple CVEs in one call."""
        return {cve_id: self.get_epss_score(cve_id) for cve_id in cve_ids}
