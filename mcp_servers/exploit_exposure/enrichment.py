"""Finding enrichment with CVE, CWE, and CPE data.

Provides a built-in catalog of common CWE entries relevant to home-network
security, along with CVE detail helpers and CPE matching.  All data is
static so the system works fully offline.
"""

from __future__ import annotations

from typing import Any

import structlog

from mcp_servers.exploit_exposure.feeds import ThreatFeedCache

logger = structlog.get_logger()

# ---------------------------------------------------------------------------
# Built-in CWE catalog (20+ entries most relevant to home network security)
# ---------------------------------------------------------------------------
CWE_CATALOG: dict[str, dict[str, Any]] = {
    "CWE-79": {
        "id": "CWE-79",
        "name": "Improper Neutralization of Input During Web Page Generation (XSS)",
        "description": (
            "The software does not neutralize or incorrectly neutralizes user-controllable "
            "input before it is placed in output used as a web page served to other users."
        ),
        "severity_boost": 0.5,
        "related_techniques": ["T1189", "T1059.007"],
    },
    "CWE-89": {
        "id": "CWE-89",
        "name": "Improper Neutralization of Special Elements used in an SQL Command (SQL Injection)",
        "description": (
            "The software constructs all or part of an SQL command using externally-influenced "
            "input without properly neutralizing special elements."
        ),
        "severity_boost": 0.8,
        "related_techniques": ["T1190", "T1059"],
    },
    "CWE-200": {
        "id": "CWE-200",
        "name": "Exposure of Sensitive Information to an Unauthorized Actor",
        "description": (
            "The product exposes sensitive information to an actor that is not explicitly "
            "authorized to have access to that information."
        ),
        "severity_boost": 0.3,
        "related_techniques": ["T1005", "T1040", "T1552"],
    },
    "CWE-295": {
        "id": "CWE-295",
        "name": "Improper Certificate Validation",
        "description": (
            "The software does not validate, or incorrectly validates, a certificate, "
            "enabling man-in-the-middle attacks."
        ),
        "severity_boost": 0.6,
        "related_techniques": ["T1557", "T1556"],
    },
    "CWE-298": {
        "id": "CWE-298",
        "name": "Improper Validation of Certificate Expiration",
        "description": (
            "The product does not check or incorrectly checks if a certificate has expired, "
            "potentially trusting revoked or stale certificates."
        ),
        "severity_boost": 0.4,
        "related_techniques": ["T1557"],
    },
    "CWE-306": {
        "id": "CWE-306",
        "name": "Missing Authentication for Critical Function",
        "description": (
            "The product does not perform any authentication for functionality that requires "
            "a provable user identity or consumes a significant amount of resources."
        ),
        "severity_boost": 0.9,
        "related_techniques": ["T1190", "T1078"],
    },
    "CWE-307": {
        "id": "CWE-307",
        "name": "Improper Restriction of Excessive Authentication Attempts",
        "description": (
            "The software does not implement sufficient measures to prevent multiple failed "
            "authentication attempts within a short time frame."
        ),
        "severity_boost": 0.5,
        "related_techniques": ["T1110"],
    },
    "CWE-311": {
        "id": "CWE-311",
        "name": "Missing Encryption of Sensitive Data",
        "description": (
            "The software does not encrypt sensitive or critical information before storage "
            "or transmission."
        ),
        "severity_boost": 0.6,
        "related_techniques": ["T1040", "T1557"],
    },
    "CWE-319": {
        "id": "CWE-319",
        "name": "Cleartext Transmission of Sensitive Information",
        "description": (
            "The software transmits sensitive or security-critical data in cleartext in a "
            "communication channel that can be sniffed by unauthorized actors."
        ),
        "severity_boost": 0.6,
        "related_techniques": ["T1040", "T1557"],
    },
    "CWE-326": {
        "id": "CWE-326",
        "name": "Inadequate Encryption Strength",
        "description": (
            "The software stores or transmits sensitive data using an encryption scheme that "
            "is theoretically sound but not strong enough for the required level of protection."
        ),
        "severity_boost": 0.4,
        "related_techniques": ["T1557", "T1040"],
    },
    "CWE-327": {
        "id": "CWE-327",
        "name": "Use of a Broken or Risky Cryptographic Algorithm",
        "description": (
            "The use of a non-standard or broken cryptographic algorithm is an unnecessary "
            "risk that may result in the exposure of sensitive information."
        ),
        "severity_boost": 0.5,
        "related_techniques": ["T1557", "T1040"],
    },
    "CWE-345": {
        "id": "CWE-345",
        "name": "Insufficient Verification of Data Authenticity",
        "description": (
            "The software does not sufficiently verify the origin or authenticity of data, "
            "in a way that causes it to accept invalid data."
        ),
        "severity_boost": 0.5,
        "related_techniques": ["T1557", "T1195"],
    },
    "CWE-400": {
        "id": "CWE-400",
        "name": "Uncontrolled Resource Consumption",
        "description": (
            "The software does not properly control the allocation and maintenance of a "
            "limited resource, allowing resource exhaustion (denial of service)."
        ),
        "severity_boost": 0.3,
        "related_techniques": ["T1499"],
    },
    "CWE-406": {
        "id": "CWE-406",
        "name": "Insufficient Control of Network Message Volume (Network Amplification)",
        "description": (
            "The software does not sufficiently monitor or control the volume of network "
            "traffic, allowing amplification or reflection attacks."
        ),
        "severity_boost": 0.3,
        "related_techniques": ["T1498"],
    },
    "CWE-434": {
        "id": "CWE-434",
        "name": "Unrestricted Upload of File with Dangerous Type",
        "description": (
            "The software allows the attacker to upload or transfer files of dangerous types "
            "that can be automatically processed within the product's environment."
        ),
        "severity_boost": 0.8,
        "related_techniques": ["T1190", "T1105"],
    },
    "CWE-521": {
        "id": "CWE-521",
        "name": "Weak Password Requirements",
        "description": (
            "The product does not require that users employ passwords that are sufficiently "
            "long or complex, making brute-force attacks easier."
        ),
        "severity_boost": 0.5,
        "related_techniques": ["T1110", "T1078"],
    },
    "CWE-693": {
        "id": "CWE-693",
        "name": "Protection Mechanism Failure",
        "description": (
            "The product does not use or incorrectly uses a protection mechanism that "
            "provides sufficient defense against directed attacks."
        ),
        "severity_boost": 0.6,
        "related_techniques": ["T1562"],
    },
    "CWE-798": {
        "id": "CWE-798",
        "name": "Use of Hard-coded Credentials",
        "description": (
            "The software contains hard-coded credentials (passwords, keys, etc.) for "
            "inbound authentication or outbound communication to external components."
        ),
        "severity_boost": 1.0,
        "related_techniques": ["T1078.001", "T1552.001"],
    },
    "CWE-1021": {
        "id": "CWE-1021",
        "name": "Improper Restriction of Rendered UI Layers or Frames (Clickjacking)",
        "description": (
            "The web application does not restrict or incorrectly restricts frame objects "
            "or UI layers, enabling clickjacking attacks."
        ),
        "severity_boost": 0.2,
        "related_techniques": ["T1189"],
    },
    "CWE-1104": {
        "id": "CWE-1104",
        "name": "Use of Unmaintained Third Party Components",
        "description": (
            "The product relies on third-party components that are no longer actively "
            "maintained, increasing the risk of unpatched vulnerabilities."
        ),
        "severity_boost": 0.7,
        "related_techniques": ["T1195.002", "T1190"],
    },
    # Bonus entries relevant to home network / IoT
    "CWE-78": {
        "id": "CWE-78",
        "name": "Improper Neutralization of Special Elements used in an OS Command (OS Command Injection)",
        "description": (
            "The software constructs all or part of an OS command using externally-influenced "
            "input without proper neutralization, allowing command injection."
        ),
        "severity_boost": 0.9,
        "related_techniques": ["T1059", "T1190"],
    },
    "CWE-287": {
        "id": "CWE-287",
        "name": "Improper Authentication",
        "description": (
            "The software does not sufficiently authenticate an actor, or authentication "
            "can be bypassed entirely."
        ),
        "severity_boost": 0.8,
        "related_techniques": ["T1078", "T1190"],
    },
    "CWE-120": {
        "id": "CWE-120",
        "name": "Buffer Copy without Checking Size of Input (Classic Buffer Overflow)",
        "description": (
            "The program copies an input buffer to an output buffer without verifying that "
            "the size of the input does not exceed the output buffer size."
        ),
        "severity_boost": 0.9,
        "related_techniques": ["T1203", "T1190"],
    },
    "CWE-22": {
        "id": "CWE-22",
        "name": "Improper Limitation of a Pathname to a Restricted Directory (Path Traversal)",
        "description": (
            "The software uses external input to construct a pathname that should be within "
            "a restricted directory, but does not properly neutralize sequences like '..'."
        ),
        "severity_boost": 0.7,
        "related_techniques": ["T1083", "T1005"],
    },
}

# ---------------------------------------------------------------------------
# Minimal local NVD-style CVE cache (summary data for the KEV entries)
# Keyed by CVE ID.  In a production system this would be loaded from a
# periodically-updated NVD JSON feed; here we embed a compact snapshot.
# ---------------------------------------------------------------------------
_NVD_CVE_CACHE: dict[str, dict[str, Any]] = {
    "CVE-2021-44228": {
        "id": "CVE-2021-44228",
        "description": "Apache Log4j2 JNDI features do not protect against attacker-controlled LDAP/JNDI URIs.",
        "cvss_v3_score": 10.0,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H",
        "severity": "critical",
        "cwe_id": "CWE-502",
        "published": "2021-12-10",
        "vendor": "Apache",
        "product": "Log4j",
    },
    "CVE-2014-0160": {
        "id": "CVE-2014-0160",
        "description": "Heartbleed: missing bounds check in TLS heartbeat extension allows memory disclosure.",
        "cvss_v3_score": 7.5,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N",
        "severity": "high",
        "cwe_id": "CWE-120",
        "published": "2014-04-07",
        "vendor": "OpenSSL",
        "product": "OpenSSL",
    },
    "CVE-2014-6271": {
        "id": "CVE-2014-6271",
        "description": "Shellshock: GNU Bash allows arbitrary code execution via crafted environment variables.",
        "cvss_v3_score": 9.8,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
        "severity": "critical",
        "cwe_id": "CWE-78",
        "published": "2014-09-24",
        "vendor": "GNU",
        "product": "Bash",
    },
    "CVE-2019-0708": {
        "id": "CVE-2019-0708",
        "description": "BlueKeep: pre-auth RCE in Windows Remote Desktop Services.",
        "cvss_v3_score": 9.8,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
        "severity": "critical",
        "cwe_id": "CWE-416",
        "published": "2019-05-14",
        "vendor": "Microsoft",
        "product": "Remote Desktop Services",
    },
    "CVE-2021-41773": {
        "id": "CVE-2021-41773",
        "description": "Path traversal and RCE in Apache HTTP Server 2.4.49.",
        "cvss_v3_score": 7.5,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:N/A:N",
        "severity": "high",
        "cwe_id": "CWE-22",
        "published": "2021-10-05",
        "vendor": "Apache",
        "product": "HTTP Server",
    },
    "CVE-2021-42013": {
        "id": "CVE-2021-42013",
        "description": "Path traversal fix bypass in Apache HTTP Server 2.4.50.",
        "cvss_v3_score": 9.8,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
        "severity": "critical",
        "cwe_id": "CWE-22",
        "published": "2021-10-07",
        "vendor": "Apache",
        "product": "HTTP Server",
    },
    "CVE-2024-6387": {
        "id": "CVE-2024-6387",
        "description": "RegreSSHion: race condition in OpenSSH sshd signal handler allows unauthenticated RCE.",
        "cvss_v3_score": 8.1,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H",
        "severity": "high",
        "cwe_id": "CWE-362",
        "published": "2024-07-01",
        "vendor": "OpenBSD",
        "product": "OpenSSH",
    },
    "CVE-2018-13379": {
        "id": "CVE-2018-13379",
        "description": "FortiOS SSL VPN path traversal allows unauthenticated reading of system files.",
        "cvss_v3_score": 9.8,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
        "severity": "critical",
        "cwe_id": "CWE-22",
        "published": "2019-06-04",
        "vendor": "Fortinet",
        "product": "FortiOS",
    },
    "CVE-2023-20198": {
        "id": "CVE-2023-20198",
        "description": "Privilege escalation in Cisco IOS XE web UI.",
        "cvss_v3_score": 10.0,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H",
        "severity": "critical",
        "cwe_id": "CWE-306",
        "published": "2023-10-16",
        "vendor": "Cisco",
        "product": "IOS XE",
    },
    "CVE-2024-3400": {
        "id": "CVE-2024-3400",
        "description": "Command injection in Palo Alto PAN-OS GlobalProtect gateway.",
        "cvss_v3_score": 10.0,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:C/C:H/I:H/A:H",
        "severity": "critical",
        "cwe_id": "CWE-78",
        "published": "2024-04-12",
        "vendor": "Palo Alto Networks",
        "product": "PAN-OS",
    },
    "CVE-2021-36260": {
        "id": "CVE-2021-36260",
        "description": "Command injection via crafted HTTP requests in Hikvision IP cameras.",
        "cvss_v3_score": 9.8,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
        "severity": "critical",
        "cwe_id": "CWE-78",
        "published": "2021-09-22",
        "vendor": "Hikvision",
        "product": "IP Cameras",
    },
    "CVE-2021-35394": {
        "id": "CVE-2021-35394",
        "description": "Multiple buffer overflows in Realtek Jungle SDK UDPServer.",
        "cvss_v3_score": 9.8,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
        "severity": "critical",
        "cwe_id": "CWE-120",
        "published": "2021-08-16",
        "vendor": "Realtek",
        "product": "Jungle SDK",
    },
    "CVE-2021-23017": {
        "id": "CVE-2021-23017",
        "description": "Off-by-one error in nginx DNS resolver allows RCE.",
        "cvss_v3_score": 7.7,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:H/I:H/A:H",
        "severity": "high",
        "cwe_id": "CWE-193",
        "published": "2021-06-01",
        "vendor": "F5 / nginx",
        "product": "nginx",
    },
    "CVE-2017-17215": {
        "id": "CVE-2017-17215",
        "description": "RCE via crafted packets to UPnP service on Huawei HG532.",
        "cvss_v3_score": 8.8,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:U/C:H/I:H/A:H",
        "severity": "high",
        "cwe_id": "CWE-78",
        "published": "2018-03-20",
        "vendor": "Huawei",
        "product": "HG532 Router",
    },
    "CVE-2022-42475": {
        "id": "CVE-2022-42475",
        "description": "Heap-based buffer overflow in FortiOS sslvpnd allows unauthenticated RCE.",
        "cvss_v3_score": 9.8,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
        "severity": "critical",
        "cwe_id": "CWE-120",
        "published": "2023-01-02",
        "vendor": "Fortinet",
        "product": "FortiOS",
    },
    "CVE-2023-27997": {
        "id": "CVE-2023-27997",
        "description": "Heap-based buffer overflow in FortiOS/FortiProxy SSL-VPN pre-authentication.",
        "cvss_v3_score": 9.8,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
        "severity": "critical",
        "cwe_id": "CWE-120",
        "published": "2023-06-13",
        "vendor": "Fortinet",
        "product": "FortiOS",
    },
    "CVE-2021-20090": {
        "id": "CVE-2021-20090",
        "description": "Authentication bypass in Arcadyan-based router firmware.",
        "cvss_v3_score": 9.8,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
        "severity": "critical",
        "cwe_id": "CWE-287",
        "published": "2021-04-29",
        "vendor": "Buffalo / Arcadyan",
        "product": "Various home routers",
    },
    "CVE-2018-10561": {
        "id": "CVE-2018-10561",
        "description": "Authentication bypass on Dasan GPON home routers.",
        "cvss_v3_score": 9.8,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
        "severity": "critical",
        "cwe_id": "CWE-287",
        "published": "2018-05-04",
        "vendor": "Dasan",
        "product": "GPON Home Routers",
    },
    "CVE-2023-44487": {
        "id": "CVE-2023-44487",
        "description": "HTTP/2 Rapid Reset DDoS attack vector affecting most HTTP/2 implementations.",
        "cvss_v3_score": 7.5,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:N/I:N/A:H",
        "severity": "high",
        "cwe_id": "CWE-400",
        "published": "2023-10-10",
        "vendor": "Multiple",
        "product": "HTTP/2 implementations",
    },
    "CVE-2022-22965": {
        "id": "CVE-2022-22965",
        "description": "Spring4Shell: RCE via data binding on JDK 9+.",
        "cvss_v3_score": 9.8,
        "cvss_v3_vector": "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
        "severity": "critical",
        "cwe_id": "CWE-94",
        "published": "2022-04-01",
        "vendor": "VMware / Spring",
        "product": "Spring Framework",
    },
}


class FindingEnricher:
    """Enriches vulnerability findings with CVE, CWE, and CPE context.

    All lookups use built-in static catalogs so the system works fully
    offline without any external API calls.
    """

    def __init__(self) -> None:
        self._cwe_catalog: dict[str, dict[str, Any]] = CWE_CATALOG
        self._nvd_cache: dict[str, dict[str, Any]] = _NVD_CVE_CACHE
        self._feed_cache = ThreatFeedCache()
        logger.info(
            "FindingEnricher initialised",
            cwe_entries=len(self._cwe_catalog),
            nvd_entries=len(self._nvd_cache),
        )

    # ------------------------------------------------------------------
    # Public API
    # ------------------------------------------------------------------

    def enrich(self, finding: dict) -> dict:
        """Enrich a finding dict with CVE details, CWE info, and CPE context.

        Parameters
        ----------
        finding : dict
            Must contain at least *title*.  Optional keys: *cve_ids*
            (``list[str]``), *cwe_id* (``str``), *cpe* (``str``),
            *severity* (``str``).

        Returns
        -------
        dict
            A copy of the original finding with added enrichment keys:
            ``cve_details``, ``cwe_info``, ``cpe_matches``,
            ``kev_status``, ``epss_scores``, ``enrichment_summary``.
        """
        enriched: dict[str, Any] = dict(finding)

        # --- CVE enrichment ---
        cve_ids: list[str] = finding.get("cve_ids") or []
        cve_details: list[dict[str, Any]] = []
        kev_status: list[dict[str, Any]] = []
        epss_scores: list[dict[str, Any]] = []

        for cve_id in cve_ids:
            cve_id_upper = cve_id.strip().upper()

            # NVD lookup
            nvd_entry = self._nvd_cache.get(cve_id_upper)
            if nvd_entry:
                cve_details.append(nvd_entry)
                logger.debug("CVE enriched from NVD cache", cve_id=cve_id_upper)
            else:
                cve_details.append({
                    "id": cve_id_upper,
                    "description": "Not available in local NVD cache.",
                    "cvss_v3_score": None,
                    "severity": None,
                })

            # KEV lookup
            kev = self._feed_cache.get_kev_status(cve_id_upper)
            if kev:
                kev_status.append(kev)

            # EPSS lookup
            epss = self._feed_cache.get_epss_score(cve_id_upper)
            if epss:
                epss_scores.append(epss)

        enriched["cve_details"] = cve_details
        enriched["kev_status"] = kev_status
        enriched["epss_scores"] = epss_scores

        # --- CWE enrichment ---
        cwe_id: str | None = finding.get("cwe_id")
        cwe_info: dict[str, Any] | None = None
        if cwe_id:
            cwe_key = cwe_id.strip().upper()
            # Normalise "79" -> "CWE-79"
            if not cwe_key.startswith("CWE-"):
                cwe_key = f"CWE-{cwe_key}"
            cwe_info = self._cwe_catalog.get(cwe_key)
            if cwe_info:
                logger.debug("CWE enriched", cwe_id=cwe_key)
            else:
                cwe_info = {
                    "id": cwe_key,
                    "name": "Unknown",
                    "description": "Not available in local CWE catalog.",
                    "severity_boost": 0.0,
                    "related_techniques": [],
                }
        # Also try to pull CWE from CVE details if the finding didn't specify one
        if cwe_info is None and cve_details:
            for cve_detail in cve_details:
                found_cwe = cve_detail.get("cwe_id")
                if found_cwe:
                    cwe_key = found_cwe.strip().upper()
                    if not cwe_key.startswith("CWE-"):
                        cwe_key = f"CWE-{cwe_key}"
                    cwe_info = self._cwe_catalog.get(cwe_key, {
                        "id": cwe_key,
                        "name": "Unknown",
                        "description": "Not available in local CWE catalog.",
                        "severity_boost": 0.0,
                        "related_techniques": [],
                    })
                    break

        enriched["cwe_info"] = cwe_info

        # --- CPE matching ---
        cpe: str | None = finding.get("cpe")
        cpe_matches = self._match_cpe(cpe, cve_details)
        enriched["cpe_matches"] = cpe_matches

        # --- Summary ---
        enriched["enrichment_summary"] = self._build_summary(
            cve_details, cwe_info, kev_status, epss_scores, cpe_matches,
        )

        logger.info(
            "Finding enrichment complete",
            title=finding.get("title", "unknown"),
            cves_enriched=len(cve_details),
            kev_hits=len(kev_status),
            epss_hits=len(epss_scores),
            cwe_resolved=cwe_info is not None,
        )
        return enriched

    # ------------------------------------------------------------------
    # Internal helpers
    # ------------------------------------------------------------------

    def _match_cpe(
        self, cpe: str | None, cve_details: list[dict[str, Any]]
    ) -> list[dict[str, Any]]:
        """Perform basic CPE matching against the local NVD cache.

        This is a simplified prefix/component match -- production systems
        would use the full CPE matching algorithm from NVD.
        """
        matches: list[dict[str, Any]] = []
        if not cpe:
            return matches

        # Parse CPE components  (cpe:2.3:a:vendor:product:version:...)
        cpe_lower = cpe.lower()
        cpe_parts = cpe_lower.split(":")
        cpe_vendor = cpe_parts[3] if len(cpe_parts) > 3 else ""
        cpe_product = cpe_parts[4] if len(cpe_parts) > 4 else ""

        for cve_id, entry in self._nvd_cache.items():
            entry_vendor = (entry.get("vendor") or "").lower()
            entry_product = (entry.get("product") or "").lower()

            # Match on vendor and/or product substring
            vendor_match = cpe_vendor and cpe_vendor in entry_vendor.replace(" ", "").lower()
            product_match = cpe_product and cpe_product in entry_product.replace(" ", "").lower()

            if vendor_match or product_match:
                matches.append({
                    "cve_id": cve_id,
                    "vendor": entry.get("vendor"),
                    "product": entry.get("product"),
                    "cvss_v3_score": entry.get("cvss_v3_score"),
                    "severity": entry.get("severity"),
                    "match_type": "vendor+product" if (vendor_match and product_match) else (
                        "vendor" if vendor_match else "product"
                    ),
                })

        if matches:
            logger.debug("CPE matches found", cpe=cpe, match_count=len(matches))

        return matches

    @staticmethod
    def _build_summary(
        cve_details: list[dict[str, Any]],
        cwe_info: dict[str, Any] | None,
        kev_status: list[dict[str, Any]],
        epss_scores: list[dict[str, Any]],
        cpe_matches: list[dict[str, Any]],
    ) -> dict[str, Any]:
        """Build a human-readable enrichment summary."""
        max_cvss = 0.0
        for cve in cve_details:
            score = cve.get("cvss_v3_score")
            if score is not None and score > max_cvss:
                max_cvss = score

        max_epss = 0.0
        for epss in epss_scores:
            if epss["epss_score"] > max_epss:
                max_epss = epss["epss_score"]

        risk_signals: list[str] = []
        if kev_status:
            risk_signals.append(f"{len(kev_status)} CVE(s) in CISA KEV - actively exploited")
        if max_epss >= 0.9:
            risk_signals.append(f"Very high EPSS score ({max_epss:.3f}) - exploit highly likely")
        elif max_epss >= 0.5:
            risk_signals.append(f"High EPSS score ({max_epss:.3f}) - exploit probable")
        if max_cvss >= 9.0:
            risk_signals.append(f"Critical CVSS score ({max_cvss})")
        elif max_cvss >= 7.0:
            risk_signals.append(f"High CVSS score ({max_cvss})")
        if cwe_info and cwe_info.get("severity_boost", 0) >= 0.8:
            risk_signals.append(f"High-danger CWE class: {cwe_info.get('name', 'unknown')}")
        if cpe_matches:
            risk_signals.append(f"{len(cpe_matches)} additional CVE(s) matched via CPE")

        return {
            "max_cvss_v3": max_cvss,
            "max_epss": max_epss,
            "kev_count": len(kev_status),
            "cpe_match_count": len(cpe_matches),
            "risk_signals": risk_signals,
        }
