"""IP reputation checks via AbuseIPDB, GreyNoise, and AlienVault OTX."""

from __future__ import annotations

import asyncio

import httpx
import structlog

logger = structlog.get_logger()


class IPReputationClient:
    """Aggregate IP reputation from multiple sources (API-key gated)."""

    def __init__(
        self,
        abuseipdb_key: str = "",
        greynoise_key: str = "",
        otx_key: str = "",
    ) -> None:
        self._abuseipdb_key = abuseipdb_key
        self._greynoise_key = greynoise_key
        self._otx_key = otx_key

    async def check_ip(self, ip: str) -> dict:
        """Run all configured reputation sources concurrently."""
        tasks = {}
        if self._abuseipdb_key:
            tasks["abuseipdb"] = self._check_abuseipdb(ip)
        if self._greynoise_key:
            tasks["greynoise"] = self._check_greynoise(ip)
        if self._otx_key:
            tasks["otx"] = self._check_otx(ip)

        if not tasks:
            return {
                "ip": ip,
                "sources_checked": 0,
                "risk_score": None,
                "details": {},
                "message": "No API keys configured for IP reputation",
            }

        results = await asyncio.gather(
            *tasks.values(), return_exceptions=True
        )
        details = {}
        scores = []
        for name, result in zip(tasks.keys(), results):
            if isinstance(result, Exception):
                details[name] = {"error": str(result)}
            elif result:
                details[name] = result
                if "score" in result:
                    scores.append(result["score"])

        # Aggregate risk score (average of available scores, 0-100)
        risk_score = sum(scores) / len(scores) if scores else None

        return {
            "ip": ip,
            "sources_checked": len(tasks),
            "risk_score": round(risk_score, 1) if risk_score is not None else None,
            "details": details,
        }

    async def _check_abuseipdb(self, ip: str) -> dict | None:
        try:
            async with httpx.AsyncClient(timeout=15) as client:
                resp = await client.get(
                    "https://api.abuseipdb.com/api/v2/check",
                    params={"ipAddress": ip, "maxAgeInDays": 90, "verbose": ""},
                    headers={"Key": self._abuseipdb_key, "Accept": "application/json"},
                )
                resp.raise_for_status()
                data = resp.json().get("data", {})
                return {
                    "source": "abuseipdb",
                    "score": data.get("abuseConfidenceScore", 0),
                    "total_reports": data.get("totalReports", 0),
                    "country_code": data.get("countryCode"),
                    "isp": data.get("isp"),
                    "usage_type": data.get("usageType"),
                    "is_tor": data.get("isTor", False),
                    "last_reported": data.get("lastReportedAt"),
                }
        except Exception as e:
            logger.warning("AbuseIPDB check failed", ip=ip, error=str(e))
            return None

    async def _check_greynoise(self, ip: str) -> dict | None:
        try:
            async with httpx.AsyncClient(timeout=15) as client:
                resp = await client.get(
                    f"https://api.greynoise.io/v3/community/{ip}",
                    headers={"key": self._greynoise_key},
                )
                resp.raise_for_status()
                data = resp.json()
                classification = data.get("classification", "unknown")
                # Convert to 0-100 score
                score_map = {"malicious": 90, "unknown": 50, "benign": 10}
                return {
                    "source": "greynoise",
                    "score": score_map.get(classification, 50),
                    "classification": classification,
                    "name": data.get("name"),
                    "noise": data.get("noise", False),
                    "riot": data.get("riot", False),
                    "last_seen": data.get("last_seen"),
                    "message": data.get("message"),
                }
        except Exception as e:
            logger.warning("GreyNoise check failed", ip=ip, error=str(e))
            return None

    async def _check_otx(self, ip: str) -> dict | None:
        try:
            async with httpx.AsyncClient(timeout=15) as client:
                resp = await client.get(
                    f"https://otx.alienvault.com/api/v1/indicators/IPv4/{ip}/general",
                    headers={"X-OTX-API-KEY": self._otx_key},
                )
                resp.raise_for_status()
                data = resp.json()
                pulse_count = data.get("pulse_info", {}).get("count", 0)
                # Score based on pulse count (threat reports mentioning this IP)
                score = min(100, pulse_count * 15) if pulse_count else 0
                return {
                    "source": "otx",
                    "score": score,
                    "pulse_count": pulse_count,
                    "reputation": data.get("reputation", 0),
                    "country_code": data.get("country_code"),
                    "asn": data.get("asn"),
                }
        except Exception as e:
            logger.warning("OTX check failed", ip=ip, error=str(e))
            return None
