import { useEffect, useState, useRef } from 'react'
import { useNavigate } from 'react-router-dom'
import PageHeader from '../common/PageHeader'
import Badge from '../common/Badge'
import Modal from '../common/Modal'
import api from '../../api/client'
import { Play, Loader2, CheckCircle2, XCircle, Clock, ChevronDown, ChevronRight } from 'lucide-react'

interface PentestAction {
  id: string
  name: string
  description: string
  risk: string
}

interface ActionFinding {
  title: string
  severity: string
  evidence?: string
  remediation?: string
}

interface ActionStatus {
  status: 'idle' | 'running' | 'completed' | 'error'
  startTime: number | null
  endTime: number | null
  findings: ActionFinding[]
  error: string | null
  findingsCreated: number
}

interface ResultModalData {
  actionName: string
  findings: ActionFinding[]
  elapsed: string
  target: string
  findingsCreated: number
}

interface HistoryItem {
  id: string
  action: string
  timestamp: string | null
  actor: string
  details: any
  run_id: string | null
}

type TabKey = 'actions' | 'results' | 'history'

export default function PentestPage() {
  const [actions, setActions] = useState<PentestAction[]>([])
  const [target, setTarget] = useState('')
  const [actionStates, setActionStates] = useState<Record<string, ActionStatus>>({})
  const [activeTab, setActiveTab] = useState<TabKey>('actions')
  const [history, setHistory] = useState<HistoryItem[]>([])
  const [historyLoading, setHistoryLoading] = useState(false)
  const timerRef = useRef<Record<string, ReturnType<typeof setInterval>>>({})
  const [, setTick] = useState(0)
  const [resultModal, setResultModal] = useState<ResultModalData | null>(null)
  const [expandedEvidence, setExpandedEvidence] = useState<Record<number, boolean>>({})
  const navigate = useNavigate()

  useEffect(() => {
    api.get('/pentest/actions').then((res) => setActions(res.data.actions || []))
    return () => {
      Object.values(timerRef.current).forEach(clearInterval)
    }
  }, [])

  const handleExecute = async (actionId: string) => {
    if (!target) return

    const startTime = Date.now()
    setActionStates((prev) => ({
      ...prev,
      [actionId]: { status: 'running', startTime, endTime: null, findings: [], error: null, findingsCreated: 0 },
    }))

    // Start elapsed timer
    timerRef.current[actionId] = setInterval(() => setTick((t) => t + 1), 1000)

    try {
      const res = await api.post('/pentest/execute', {
        action_id: actionId,
        target,
      })
      clearInterval(timerRef.current[actionId])

      if (res.data.status === 'error') {
        setActionStates((prev) => ({
          ...prev,
          [actionId]: { status: 'error', startTime, endTime: Date.now(), findings: [], error: res.data.error, findingsCreated: 0 },
        }))
      } else {
        const findings = (res.data.findings || []).filter((f: any) => f.severity !== 'info')
        const mappedFindings: ActionFinding[] = findings.map((f: any) => ({
          title: f.title,
          severity: f.severity,
          evidence: f.evidence,
          remediation: f.remediation,
        }))
        const findingsCreated = res.data.findings_created || 0
        setActionStates((prev) => ({
          ...prev,
          [actionId]: {
            status: 'completed', startTime, endTime: Date.now(),
            findings: mappedFindings,
            error: null, findingsCreated,
          },
        }))

        // Auto-open result modal
        const actionName = actions.find((a) => a.id === actionId)?.name || actionId
        setResultModal({
          actionName,
          findings: mappedFindings,
          elapsed: formatElapsed(startTime, Date.now()),
          target,
          findingsCreated,
        })
        setExpandedEvidence({})
      }
    } catch (err: any) {
      clearInterval(timerRef.current[actionId])
      setActionStates((prev) => ({
        ...prev,
        [actionId]: { status: 'error', startTime, endTime: Date.now(), findings: [], error: err.message || 'Execution failed', findingsCreated: 0 },
      }))
    }
  }

  async function loadHistory() {
    setHistoryLoading(true)
    try {
      const res = await api.get('/pentest/history', { params: { limit: 50 } })
      setHistory(res.data.history || [])
    } catch { /* empty */ }
    setHistoryLoading(false)
  }

  function formatElapsed(startTime: number, endTime: number | null) {
    const elapsed = ((endTime || Date.now()) - startTime) / 1000
    if (elapsed < 60) return `${Math.floor(elapsed)}s`
    return `${Math.floor(elapsed / 60)}m ${Math.floor(elapsed % 60)}s`
  }

  // Get all session findings
  const sessionFindings = Object.entries(actionStates)
    .filter(([, s]) => s.status === 'completed')
    .flatMap(([actionId, s]) =>
      s.findings.map((f) => ({ ...f, actionId }))
    )

  const tabs: Array<{ key: TabKey; label: string; count?: number }> = [
    { key: 'actions', label: 'Actions' },
    { key: 'results', label: 'Results', count: sessionFindings.length },
    { key: 'history', label: 'History' },
  ]

  return (
    <div>
      <PageHeader
        title="Pentest Module"
        description="Guardrailed penetration testing actions"
      />

      <div className="card p-4 mb-6">
        <label className="block text-sm font-medium text-gray-700 mb-2">Target IP/Hostname</label>
        <input
          type="text"
          value={target}
          onChange={(e) => setTarget(e.target.value)}
          placeholder="e.g., 192.168.178.1"
          className="w-full px-3 py-2 border rounded-lg text-sm focus:ring-2 focus:ring-brand-500 focus:border-brand-500"
        />
      </div>

      {/* Tabs */}
      <div className="flex gap-1 mb-4 border-b">
        {tabs.map((tab) => (
          <button
            key={tab.key}
            onClick={() => {
              setActiveTab(tab.key)
              if (tab.key === 'history' && history.length === 0) loadHistory()
            }}
            className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
              activeTab === tab.key
                ? 'border-brand-600 text-brand-600'
                : 'border-transparent text-gray-500 hover:text-gray-700'
            }`}
          >
            {tab.label}
            {tab.count !== undefined && tab.count > 0 && (
              <span className="ml-1.5 bg-brand-100 text-brand-700 px-1.5 py-0.5 rounded-full text-xs">{tab.count}</span>
            )}
          </button>
        ))}
      </div>

      {/* Actions Tab */}
      {activeTab === 'actions' && (
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {actions.map((action) => {
            const state = actionStates[action.id]
            return (
              <div key={action.id} className="card p-5">
                <div className="flex items-start justify-between mb-3">
                  <h3 className="font-medium">{action.name}</h3>
                  <Badge variant={action.risk === 'low' ? 'low' : 'medium'}>{action.risk} risk</Badge>
                </div>
                <p className="text-sm text-gray-500 mb-4">{action.description}</p>

                {/* Status indicator */}
                {state && state.status !== 'idle' && (
                  <div className="mb-3 p-2 rounded-lg bg-gray-50">
                    {state.status === 'running' && (
                      <div className="flex items-center gap-2 text-sm text-brand-600">
                        <Loader2 className="w-4 h-4 animate-spin" />
                        <span>Running... {formatElapsed(state.startTime!, null)}</span>
                      </div>
                    )}
                    {state.status === 'completed' && (
                      <div>
                        <div className="flex items-center gap-2 text-sm text-green-600">
                          <CheckCircle2 className="w-4 h-4" />
                          <span>Completed in {formatElapsed(state.startTime!, state.endTime)}</span>
                          <span className="text-gray-500">({state.findings.length} findings)</span>
                        </div>
                        {state.findings.length > 0 && (
                          <div className="mt-2 space-y-1">
                            {state.findings.map((f, i) => (
                              <div key={i} className="flex items-center gap-2 text-xs">
                                <Badge variant={f.severity as any}>{f.severity}</Badge>
                                <span className="truncate">{f.title}</span>
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    )}
                    {state.status === 'error' && (
                      <div className="flex items-center gap-2 text-sm text-red-600">
                        <XCircle className="w-4 h-4" />
                        <span className="truncate">{state.error || 'Failed'}</span>
                      </div>
                    )}
                  </div>
                )}

                <button
                  onClick={() => handleExecute(action.id)}
                  disabled={!target || state?.status === 'running'}
                  className="btn-primary w-full flex items-center justify-center gap-2"
                >
                  {state?.status === 'running' ? (
                    <><Loader2 className="w-4 h-4 animate-spin" /> Running...</>
                  ) : (
                    <><Play className="w-4 h-4" /> Execute</>
                  )}
                </button>
              </div>
            )
          })}
        </div>
      )}

      {/* Results Tab */}
      {activeTab === 'results' && (
        <div className="card">
          <div className="px-4 py-3 border-b">
            <h3 className="font-semibold text-sm">Session Findings ({sessionFindings.length})</h3>
          </div>
          <div className="divide-y">
            {sessionFindings.length === 0 ? (
              <div className="p-6 text-center text-gray-500 text-sm">
                No findings from this session yet. Execute a test to see results here.
              </div>
            ) : (
              sessionFindings.map((f, i) => (
                <div key={i} className="px-4 py-3 flex items-center gap-3">
                  <Badge variant={f.severity as any}>{f.severity}</Badge>
                  <span className="text-sm flex-1 truncate">{f.title}</span>
                  <span className="text-xs text-gray-400">{f.actionId}</span>
                </div>
              ))
            )}
          </div>
        </div>
      )}

      {/* History Tab */}
      {activeTab === 'history' && (
        <div className="card">
          <div className="px-4 py-3 border-b flex items-center justify-between">
            <h3 className="font-semibold text-sm">Execution History</h3>
            <button onClick={loadHistory} className="text-xs text-brand-600 hover:text-brand-800">Refresh</button>
          </div>
          <div className="divide-y">
            {historyLoading ? (
              <div className="flex items-center justify-center py-8">
                <Loader2 className="w-5 h-5 animate-spin text-brand-500" />
              </div>
            ) : history.length === 0 ? (
              <div className="p-6 text-center text-gray-500 text-sm">
                No pentest history recorded yet.
              </div>
            ) : (
              history.map((h) => (
                <div key={h.id} className="px-4 py-3">
                  <div className="flex items-center gap-3">
                    <Clock className="w-4 h-4 text-gray-400" />
                    <span className="text-sm font-medium">{h.action}</span>
                    <span className="text-xs text-gray-400 ml-auto">
                      {h.timestamp ? new Date(h.timestamp).toLocaleString() : '-'}
                    </span>
                  </div>
                  {h.details && (
                    <div className="ml-7 mt-1 text-xs text-gray-500">
                      {h.details.target && <span>Target: {h.details.target}</span>}
                    </div>
                  )}
                </div>
              ))
            )}
          </div>
        </div>
      )}

      {/* Result Modal */}
      <Modal
        open={!!resultModal}
        onClose={() => setResultModal(null)}
        title={`Results â€” ${resultModal?.actionName || ''}`}
        footer={
          <>
            <button
              className="btn-secondary text-sm"
              onClick={() => {
                setResultModal(null)
                setActiveTab('results')
              }}
            >
              Go to Results
            </button>
            <button className="btn-primary text-sm" onClick={() => setResultModal(null)}>
              Close
            </button>
          </>
        }
      >
        {resultModal && (
          <div className="space-y-4">
            {/* Summary */}
            <div className="flex items-center gap-4 text-sm">
              <span className="text-gray-500">Target: <span className="font-mono font-medium text-gray-800">{resultModal.target}</span></span>
              <span className="text-gray-500">Elapsed: <span className="font-medium text-gray-800">{resultModal.elapsed}</span></span>
            </div>

            <div className="flex items-center gap-3 p-3 rounded-lg bg-gray-50">
              <CheckCircle2 className="w-5 h-5 text-green-500" />
              <span className="text-sm font-medium">
                {resultModal.findings.length} finding{resultModal.findings.length !== 1 ? 's' : ''} detected
              </span>
              {resultModal.findingsCreated > 0 && (
                <span className="text-xs text-green-600 bg-green-50 px-2 py-0.5 rounded-full">
                  {resultModal.findingsCreated} new
                </span>
              )}
            </div>

            {/* Findings list */}
            {resultModal.findings.length === 0 ? (
              <p className="text-sm text-gray-500 text-center py-4">No significant findings detected.</p>
            ) : (
              <div className="space-y-2">
                {resultModal.findings.map((f, i) => (
                  <div key={i} className="border rounded-lg overflow-hidden">
                    <div className="flex items-start gap-2 px-3 py-2">
                      <Badge variant={f.severity as any}>{f.severity}</Badge>
                      <span className="text-sm font-medium flex-1">{f.title}</span>
                      {(f.evidence || f.remediation) && (
                        <button
                          onClick={() => setExpandedEvidence((prev) => ({ ...prev, [i]: !prev[i] }))}
                          className="text-gray-400 hover:text-gray-600 shrink-0"
                        >
                          {expandedEvidence[i] ? <ChevronDown className="w-4 h-4" /> : <ChevronRight className="w-4 h-4" />}
                        </button>
                      )}
                    </div>
                    {expandedEvidence[i] && (
                      <div className="px-3 pb-2 space-y-1 border-t bg-gray-50">
                        {f.evidence && (
                          <div className="mt-2">
                            <span className="text-xs font-semibold text-gray-500 uppercase">Evidence</span>
                            <pre className="text-xs text-gray-600 whitespace-pre-wrap mt-0.5 font-mono bg-white rounded p-2 border">{f.evidence}</pre>
                          </div>
                        )}
                        {f.remediation && (
                          <div className="mt-1">
                            <span className="text-xs font-semibold text-gray-500 uppercase">Remediation</span>
                            <p className="text-xs text-blue-700 mt-0.5">{f.remediation}</p>
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                ))}
              </div>
            )}
          </div>
        )}
      </Modal>
    </div>
  )
}
