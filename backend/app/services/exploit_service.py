import json
from sqlalchemy.ext.asyncio import AsyncSession
from sqlalchemy import select

from app.models.finding import Finding
from app.models.asset import Asset
from app.evidence.artifact_store import ArtifactStore
from app.evidence.audit_trail import AuditTrail
import structlog

logger = structlog.get_logger()


class ExploitEnrichmentService:
    def __init__(self, db: AsyncSession):
        self.db = db
        self.artifact_store = ArtifactStore(db)
        self.audit_trail = AuditTrail(db)

    async def run_enrichment(
        self, asset_id: str | None = None, run_id: str | None = None
    ) -> dict:
        """Enrich findings with exploitability scores and CVE/CWE data."""
        logger.info("Starting exploit enrichment", asset_id=asset_id, run_id=run_id)

        await self.audit_trail.log(
            event_type="step_start", entity_type="run",
            entity_id=run_id or "manual", actor="system",
            action="exploit_analysis_start", run_id=run_id,
        )

        # Get findings to enrich
        query = select(Finding)
        if asset_id:
            query = query.where(Finding.asset_id == asset_id)
        result = await self.db.execute(query)
        findings = list(result.scalars().all())

        enriched_count = 0
        enrichment_results = []

        for finding in findings:
            try:
                # Get asset for context
                asset_result = await self.db.execute(
                    select(Asset).where(Asset.id == finding.asset_id)
                )
                asset = asset_result.scalar_one_or_none()
                if not asset:
                    continue

                enrichment = self._enrich_finding(finding, asset)
                enrichment_results.append(enrichment)

                # Update finding with enrichment data
                if enrichment.get("exploitability_score") is not None:
                    finding.exploitability_score = enrichment["exploitability_score"]
                    finding.exploitability_rationale = enrichment.get("rationale")
                    enriched_count += 1

            except Exception as e:
                logger.error("Enrichment failed", finding_id=finding.id, error=str(e))

        # Store artifact
        summary = {
            "findings_enriched": enriched_count,
            "total_findings": len(findings),
        }
        await self.artifact_store.store(
            content=json.dumps(
                {"enrichments": enrichment_results, "summary": summary},
                indent=2, default=str,
            ),
            artifact_type="raw_output",
            tool_name="exploit_enrichment",
            target="all_findings" if not asset_id else asset_id,
            run_id=run_id,
            command=f"exploit_enrichment asset_id={asset_id}",
            parameters={"asset_id": asset_id},
        )

        await self.audit_trail.log(
            event_type="step_complete", entity_type="run",
            entity_id=run_id or "manual", actor="system",
            action="exploit_analysis_complete", run_id=run_id,
            new_value=summary,
        )

        logger.info("Exploit enrichment complete", enriched=enriched_count)
        return {
            "status": "completed",
            "findings_enriched": enriched_count,
            "total_findings": len(findings),
        }

    def _enrich_finding(self, finding: Finding, asset: Asset) -> dict:
        """Enrich a finding with exploitability scoring."""
        from mcp_servers.exploit_exposure.scoring import ExploitabilityScorer
        from mcp_servers.exploit_exposure.enrichment import FindingEnricher

        enricher = FindingEnricher()
        scorer = ExploitabilityScorer()

        # Build finding dict
        finding_data = {
            "title": finding.title,
            "severity": finding.severity,
            "category": finding.category,
            "cve_ids": finding.cve_ids or [],
            "cwe_id": finding.cwe_id,
            "cpe": finding.cpe,
            "source_tool": finding.source_tool,
            "source_check": finding.source_check,
        }

        # Build asset dict
        asset_data = {
            "ip_address": asset.ip_address,
            "asset_type": asset.asset_type or "unknown",
            "zone": asset.zone or "lan",
            "criticality": asset.criticality or "medium",
            "exposure": asset.exposure or {},
            "data_types": asset.data_types or [],
        }

        # Enrich with CWE/CVE data
        enriched = enricher.enrich(finding_data)

        # Calculate exploitability score
        score_result = scorer.calculate(enriched, asset_data)

        return {
            "finding_id": finding.id,
            "finding_title": finding.title,
            "exploitability_score": score_result["score"],
            "rationale": score_result.get("factors"),
            "cwe_info": enriched.get("cwe_info"),
            "kev_status": enriched.get("kev_status"),
            "epss_score": enriched.get("epss_score"),
        }
